# Energy Planner

Plan when your devices should be switched on or off based on electricity price.

## Introduction

This is an add-on for [Home Assistant](https://www.home-assistant.io/), which runs a background
job every hour. This job:
* Downloads the latest electricity prices
* If prices are available for the next day it runs planning for your devices
* Planning optimizes at what times your devices should be turned on and off on the next day
* It saves the electricity prices and plans in `/config/data/energy-planner`
* The files in that directory can then be used to create virtual sensors in Home Assistant that
  trigger your automation to turn your devices on and off

## Download

Connect to your Home Assistant with SSH. In the SSH session, do the following:

* Change to the Add-ons directory:
  ```
  cd /addons
  ```
* Clone the repository:
  ```
  git clone https://github.com/patrsc/energy-planner.git
  cd energy-planner
  ```

## Customize

If desired, you can adjust the add-on by changing its files:
* In `energy_planner/config.py` you can adjust basic settings such as the repo where electricity
prices should be obtained from.
* You can also adjust `CustomPriceAdapter` there to change the algorithm how to download an process
electricity prices.
* You can also implement additional devices (see `Settings.devices` and the `devices` folder).
* The default device is a water boiler (`boiler.py`) which should be turned on in a window of
3 hours per day where electricity prices are lowest. If there is a problem in downloading price
data, 2 hours before the "deadline" 0:00 a fallback plan will be computed for the next day
(turning on the boiler at fixed time from 12:00 to 15:00).

## Install

* Open the Home Assistant website
* Go to *Settings → Add-ons*
* Click *Add-on store* in the bottom right corner
* On the top right overflow menu, click the *Check for updates* button
* Refresh your webpage when needed
* You should now see a new section at the top of the store called *Local add-ons* that lists the *Energy Planner* add-on
* Click on it to go to the add-on details page.
* Install the add-on (might take several minutes)
* Start the add-on
* Optionally turn on Watchdog
* Check the logs of the addon if everything looks normal

## Automate

### Sensors

Copy the addon directory (needs to be done again after addon customizations):

```
rm -rf /config/data/energy_planner/addon && cp -r /addons/energy-planner /config/data/energy_planner/addon
```

In your Home Assistant `configuration.yaml` add the following sensors:

```yaml
command_line:
  - sensor:
      name: "Electricity Price"
      unique_id: "PASTE_UNIQUE_RANDOM_UUID_HERE"
      command: "bash /config/data/energy_planner/addon/sensor.sh price"
      unit_of_measurement: "cent/kWh"
      scan_interval: 60
      value_template: "{{ value | float }}"
  - sensor:
      name: "Electricity Price (30 day mean)"
      unique_id: "PASTE_UNIQUE_RANDOM_UUID_HERE"
      command: "bash /config/data/energy_planner/addon/sensor.sh price mean 30"
      unit_of_measurement: "cent/kWh"
      scan_interval: 43200
      value_template: "{{ value | float }}"
  - binary_sensor:
      name: "Boiler target state"
      unique_id: "PASTE_UNIQUE_RANDOM_UUID_HERE"
      command: "bash /config/data/energy_planner/addon/sensor.sh plan boiler"
      payload_on: "on"
      payload_off: "off"
      scan_interval: 60
  - binary_sensor:
      name: "Boiler optimal"
      unique_id: "PASTE_UNIQUE_RANDOM_UUID_HERE"
      command: "bash /config/data/energy_planner/addon/sensor.sh info boiler"
      payload_on: "optimal"
      payload_off: "fallback"
      scan_interval: 3600
```

Replace the values at `unique_id` with random values generated by a [UUID Generator](https://www.uuidgenerator.net/version4).
This allows you to make additional settings in the UI (e.g. set decimal places, area or labels).

You can also use the operations `max` and `min` instead of mean and adjust the days as desired.

Restart Home Assistant or reload YAML configuration.

You can use the electricity price to show it live in dashboards and the state of devices to make
automations (see next section).

**Note:** Check if the sensors show up with reasonable values in the UI, otherwise the following automations
will not work.

### Create automations

Let us create 2 automations:
* one that turns the device *Boiler* on and off based on the plan (using sensor *Boiler target state*)
* one that sends a notification to the user's phone (using Home Assistant app) whenever the
  plan turns from *optimal* to *fallback*, using sensor *Boiler optimal*

**Automation to turn Boiler on and off**
* Turn boiler on when target state becomes on:
  * Go to *Settings → Automations and scenes → Automations → Create automation*
  * Click *Create new automation*
  * Under trigger choose *Entity → State* and choose entity *Boiler target state*
  * Under *To* select *On*
  * Under *Then* select *Add action* and choose your switch (Switch *on*) for your boiler device
  * Click *Save* and name it *Boiler planned on*
* Turn boiler off when target state becomes off:
  * Repeat the same but with *off* instead of *on*

**Automation to send notification**
* Go to *Settings → Automations and scenes → Automations → Create automation*
* Click *Create new automation*
* Under trigger choose *Entity → State* and choose entity *Boiler optimal*
* Under *From* select *On*
* Under *Then* select *Add action* and select *Notifications*, then *Send notification via mobile app*
* Under *Message* write the text *Boiler was not planned optimally.*
* Select *Title* and write *Boiler Plan*
* Click *Save* and name it *Boiler plan notification*
