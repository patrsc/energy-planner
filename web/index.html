<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Energy Planner</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
</head>
<body>

<h1>Energy Planner</h1>
<label for="date-picker">Date:</label>
<input type="date" id="date-picker" required/>
<button onclick="changeDateToday()">Today</button>
<button onclick="changeDateBy(-1)">Previous</button>
<button onclick="changeDateBy(1)">Next</button>
<p>Device:</p>
<div id="device-list"></div>
<p id="plan"></p>
<p id="prices"></p>
</body>
</html>

<script>
let energyPlannerData = {
    devices: [],
    selectedDeviceIndex: 0,
}

async function main() {
    try {
        setDate(getCurrentLocalDate())
        energyPlannerData.devices = await fetchData('api/devices')
        updateDeviceList()
        addDateEventListener()
        await update()
    } catch (error) {
        alert(`An error occurred: ${error}`);
    }
}

async function fetchData(url) {
    console.log('fetch', url)
    const response = await fetch(url);
    if (!response.ok) {
        throw new Error(`HTTP error: status: ${response.status}`);
    }
    const data = await response.json();
    return data;
}

function getCurrentLocalDate() {
    const today = new Date()
    return toDateString(today)
}

function toDateString(date) {
    const year = date.getFullYear()
    const month = String(date.getMonth() + 1).padStart(2, '0')
    const day = String(date.getDate()).padStart(2, '0')
    return `${year}-${month}-${day}`
}

function getDatePicker() {
    return document.getElementById('date-picker')
}

function setDate(date) {
    getDatePicker().value = date
}

function addDateEventListener() {
    getDatePicker().addEventListener('change', update)
}

function getDate() {
    return getDatePicker().value
}

function changeDateBy(days) {
      const input = getDatePicker();
      const currentDate = new Date(input.value);
      currentDate.setDate(currentDate.getDate() + days);
      input.value = toDateString(currentDate);
      update()
}

function changeDateToday() {
    setDate(getCurrentLocalDate())
    update()
}

async function update() {
    const date = getDate()
    if (date != '') {
        const device = energyPlannerData.devices[energyPlannerData.selectedDeviceIndex]
        console.log("update", date, device.name)
        await updatePriceData(date)
        await updatePlanData(device.name, date)
    }
}

async function updatePriceData(date) {
    const element = document.getElementById("prices")
    const data = await fetchData(`api/prices/${date}`)
    element.innerHTML = ""
    if (data === null) {
        element.innerHTML = "Prices not available."
        return
    }
    const title = document.createElement("div")
    title.innerHTML = `Prices:`
    element.appendChild(title)
    const list = document.createElement("ul")
    for (let item of data) {
        const li = document.createElement("li")
        li.innerHTML = `${formatTime(item.time)}: ${round(item.price)}`
        list.appendChild(li)
    }
    element.appendChild(list)
}

function round(number) {
    return Math.round(number * 100) / 100;  // 2 decimals
}

async function updatePlanData(device, date) {
    const element = document.getElementById("plan")
    const data = await fetchData(`api/plans/${device}/${date}`)
    element.innerHTML = ""
    if (data === null) {
        element.innerHTML = "Plan not available."
        return
    }
    const title = document.createElement("div")
    title.innerHTML = `Plan (${data.info}):`
    element.appendChild(title)
    const list = document.createElement("ul")
    for (let event of data.events) {
        const li = document.createElement("li")
        li.innerHTML = `${formatTime(event.time)}: ${event.state}`
        list.appendChild(li)
    }
    element.appendChild(list)
}

function formatTime(isoString) {
    const date = new Date(isoString);
    const hours = String(date.getHours()).padStart(2, '0');
    const minutes = String(date.getMinutes()).padStart(2, '0');
    return `${hours}:${minutes}`;
}

function getDeviceListElement() {
    return document.getElementById("device-list")
}

function updateDeviceList() {
    const list = getDeviceListElement()
    list.innerHTML = ""
    for (let i = 0; i < energyPlannerData.devices.length; i++) {
        const device = energyPlannerData.devices[i]
        let el = document.createElement("button")
        if (i == energyPlannerData.selectedDeviceIndex) {
            el.className = "active"
        }
        el.innerHTML = device.pretty_name
        el.addEventListener("click", () => selectDevice(i))
        list.appendChild(el)
    }
}

function selectDevice(index) {
    energyPlannerData.selectedDeviceIndex = index
    updateDeviceList()
    update()
}

document.addEventListener('DOMContentLoaded', function() {
    main()
})
</script>

<style>
html, body {
    font-family: sans-serif;
}
button.active {
    font-weight: bold;
}
</style>
